<apex:page sidebar="true" standardStylesheets="false" showHeader="true" controller="IMH_QuestionnaireController" id="thePage" action="{!createAnswersOnLoad}">
    

    <apex:stylesheet value="{!URLFOR($Resource.TreeViewPlugin, '/TreeViewPlugin/styles.css')}" id="pluginCSS"/>
    <apex:stylesheet value="{!URLFOR($Resource.TreeViewPlugin, '/TreeViewPlugin/css/jquery.treegrid.css')}" id="jQUeryCSS"/>
        <style>
        .treegrid-indent {width:16px; height: 16px; display: inline-block; position: relative;}
        .treegrid-expander {width:20px; height: 16px; display: inline-block; position: relative;}
        .treegrid-expander-expanded{background-image: url({!URLFOR($Resource.TreeViewPlugin,'/TreeViewPlugin/img/collapse.png')}); }
        .treegrid-expander-collapsed{background-image: url({!URLFOR($Resource.TreeViewPlugin,'/TreeViewPlugin/img/expand.png')});}
        
        .tree{
            width:100%; 
            border-collapse:collapse; 
            font-size:small;
        }
        
        /* provide some minimal visual accomodation for IE8 and below */
        .tree tr{
            border:1px solid rgba(209,233,241, 1);
        }
        .tree td {
          text-align:left;
          padding:10px 10px;
        }
        
        .tableA td {
          text-align:left;
          padding:10px 10px;
        }
        .tableA{
            border:0px solid #01A9DB;
            
            top:6px;
        }
        
        .errorMsg{
            color:red;
        }
        
        .progressBar{
            background-color: #f8f8f8;
            border:1px solid #DDDDDD;
            float:right;
            border-radius:6px;
            height: 25px;
            width: 250px;
            -moz-border-radius: 5px; 
            -webkit-border-radius: 5px;
            position:relative;
        }
        .progress{
            border-radius:6px;
            height: 100%;
            text-align: center;
            -moz-border-radius: 5px; 
            -webkit-border-radius: 5px;
            line-height: 24px;
            position:absolute;
        }
        .descriptionTable{
            border:1px solid rgba(209,233,241, 1);
            font-size:15px;
            font-weight:bolder;
        }   
        
        .loadingImage { vertical-align:bottom; }.loadingDescription { padding:0 1.5em 0 0.5em; }
        .loadingHolder {
             background-color: #FFFFCC;
             border: 1px solid #333333;
             font-size: 1em;
             font-weight: bold;
             padding: 0.4em;
             position: fixed;
             top: 50%;
             right:48%;
             white-space: nowrap;
        }
        .loadingDiv {
             background-color: lightgrey;
             opacity: .75;
             filter: alpha(opacity=75); /* IE's opacity*/
             text-align: center;
             width: 100%;
             height: 100%;
             position: absolute;
             z-index: 300;
             top: 0;
             left: 0%;
        }

    </style>
    
     <apex:pageMessages id="pageMessage"></apex:pageMessages>
    <apex:form id="theForm">
        <apex:actionFunction name="redirectFunction" action="{!exitAction}" id="redirectAF"/>
        <apex:actionFunction name="dummyRender" action="{!dummyRender}" id="dummyRenderAF"/>
        <apex:outputPanel id="thePanel" rendered="{!!systemError}"> 
            
            <table  class="tableA">
                <tr >
                    <td style="padding-bottom: 0px;padding-left: 0px;padding-top: 7px;padding-right: 0px;">
                        <table style="background-color: #1797C0;border-radius:7px">
                            <tr >
                                <td colspan="2">
                                    <apex:outputPanel style="font-weight:bolder;font-size:15px;color:white;" id="outputPanelVersionUsed">
                                         {!qWrapper.mArchivedSectionWrapper[ansset.Id].answerSetName} {!IF($Profile.Name=='System Administrator','[v' + TEXT(ansset.VersionUsed__c) + ']','')}
                                    </apex:outputPanel>
                                    <div class="progressBar" >
                                        <div class="progress" style="font-style:italic ;width: {!percentCompletion}%;background-color:{!IF(percentCompletion<=50,'#FF6961',IF(percentCompletion==100,'#77DD77','#FFbe61'))};">
                                        </div>
                                        <div class="progress" style="font-style:italic ;font-weight:bolder;font-size:13px;width: 100%;background-color:transparent;">
                                            {!percentCompletion}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                    </td>
                </tr>
                <tr >
                    <td style="padding-bottom: 0px;padding-left: 0px;padding-top: 7px;padding-right: 0px;">
                        <table class="descriptionTable">
                            <tr >
                                <td colspan="2">
                                    <div class="descriptionPanel">
                                        <apex:outputPanel id="outputPanelDescription">
                                           {!qWrapper.mArchivedSectionWrapper[ansset.Id].answerSetDescription}
                                        </apex:outputPanel>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        <apex:outputPanel id="theErrorMsgPanel" rendered="{!warningError}" >
                            <div style="height: 10px;"></div>
                            <div align="center" style="color:red;height: 27px;">
                                {!$Label.IMH_VerifyAllError}
                            </div>
                        </apex:outputPanel>
                    </td>
                </tr> 
                <apex:repeat value="{!sortedQuestionSet}" var="counter" >
                <tr >
                   <td style="padding-bottom: 0px;padding-left: 0px;padding-top: 7px;padding-right: 0px;">
                       <apex:outputPanel rendered="{!IF(!qWrapper.mArchivedSectionWrapper[sortedQuestionSet[counter]].isParent,'true','false')}">
                        <table style="background-color: #D1E9F1 ;border-radius:0px">
                            <tr >
                                <td colspan="2">
                                    <apex:outputPanel style="font-weight:bolder;font-size:15px;color:black;" id="outputPanelVersionUsed">
                                       {!qWrapper.mArchivedSectionWrapper[sortedQuestionSet[counter]].answerSetName}
                                    </apex:outputPanel>
                                    <apex:outputPanel style="float: right;">
                                        <span class="helpButton" id="{!sortedQuestionSet[counter]}-_help">
                                        <img src="/s.gif" class="helpOrb"/>
                                        <script type="text/javascript">
                                            sfdcPage.setHelp('{!sortedQuestionSet[counter]}', "{!qWrapper.mArchivedSectionWrapper[sortedQuestionSet[counter]].answerSetDescription}");
                                          </script>
                                        </span>
                                    </apex:outputPanel>
                                </td>
                            </tr>
                        </table>
                       </apex:outputPanel>
                    </td>
               </tr>
                <tr style="background: none ">
                    <td style="padding-bottom: 7px;padding-left: 0px;padding-top: 7px;padding-right: 0px;">
                        
                        <table class="tree" style="width:100%" >
                            
                            <apex:repeat value="{!qWrapper.mQuestionSetWrapper[sortedQuestionSet[counter]]}" var="qWrap" id="theRepeat">
                                <tr>
                                    <td style="display:none;">
                                        <apex:outputPanel rendered="{!IF(AND(qWrap.parentAnswer==null,qWrap.isWarning==false),true,IF(AND(qWrap.answer.DependantEntryCriteria__c == mAnswerByQuesId[qWrap.parentAnswer.Id],qWrap.notValidToRender!=true,qWrap.isWarning==false),true,false))}">
                                            <tr class="{!qWrap.cssClassName}">
                                                <td style="width:85%;">
                                                    <div style="width: {!80 - (FLOOR(qWrap.wrapperTreeLevel/5)*5)}%; display: inline-table;">
                                                        <apex:outputText value="{!qWrap.questionTextToDisplay}" escape="false"></apex:outputText>
                                                        
                                                    </div></td>
                                                <td style="float:right;border-bottom:none;" >
                                                    <apex:selectList style="color:{!IF(qWrap.answer.Answer__c == 'None','black','#77DD77')}" id="chooseAnswer" value="{!qWrap.answer.Answer__c}" size="1"  rendered="{!If(OR(qWrap.questionRecordType == 'Yes_No_NA',qWrap.questionRecordType == 'Yes_No',qWrap.questionRecordType == 'Picklist'),true,false)}" disabled="{!IF(Pagemode=='view',true,false)}">
                                                        <apex:selectOptions value="{!qWrap.pickListValues}" id="responseValues"></apex:selectOptions>
                                                        <apex:actionSupport event="onchange" action="{!onChangeOfAnswer}"  status="LoadingStatusSpinner" reRender="thePanel,scriptPanel">
                                                            <apex:param name="selectedQID" value="{!qWrap.answer.Id}"/>
                                                            <apex:param name="selectedQuestionSetId" value="{!sortedQuestionSet[counter]}"/>
                                                        </apex:actionSupport>
                                                    </apex:selectList>
                                                    <apex:inputField value="{!qWrap.answer.Answer__c}" rendered="{!If(AND(qWrap.questionRecordType == 'Freetext',pageMode!='view'),true,false)}"/>
                                                    <apex:outputField value="{!qWrap.answer.Answer__c}" rendered="{!If(AND(qWrap.questionRecordType == 'Freetext',pageMode=='view'),true,false)}"/>
                                                </td>
                                            </tr>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF((qWrap.isWarning==true),IF(qWrap.ansWarning.EntryCriteria__c == mAnswerByQuesId[qWrap.parentAnswer.Id],true,false),false)}">
                                            <tr class="{!qWrap.cssClassName}">
                                                <td style="width:85%;"><apex:outputText value="{!qWrap.ansWarning.FlagIcon__c}" escape="false"/> 
                                                    <apex:outputText value="    " style="white-space: pre" id="blankOutPutText1"/>
                                                    <apex:outputText value="{!qWrap.questionTextToDisplay} "  style="width: {!80 - (FLOOR(qWrap.wrapperTreeLevel/5)*5)}%; display: inline-table;font-weight:{!IF(qWrap.ansWarning.Flag__c=='Red','bolder','')}" escape="false"/>
                                                    <div style="color:red;height: {!IF(qWrap.errorMessage!='','19px','8px')};position:relative;left:{!100-(92 - qWrap.wrapperTreeLevel)}%;" >
                                                        <apex:outputText rendered="{!IF(AND(qWrap.errorMessage!=''),true,false)}" value="{!qWrap.errorMessage}"></apex:outputText>
                                                    </div>
                                                    <div id="{!qWrap.ansWarning.Id}">
                                                        <apex:outputPanel rendered="{!IF(AND(qWrap.warningResponse=='File evidence to be attached'),'true','false')}" style="float: right; width: {!(92.5 - qWrap.wrapperTreeLevel)}%;">
                                                        <apex:inputText value="{!qWrap.ansWarning.SYSAttachmentId__c}" styleClass="inputHidden" style="display:none;"/> 
                                                        <apex:outputPanel rendered="{!IF(AND(LEN(qWrap.ansWarning.SYSAttachmentId__c)==0,pageMode!='view'),'true','false')}" > 
                                                        <input id="{!qWrap.ansWarning.Id}" class= "fileInput" type="file" onchange = "uploadFile('{!qWrap.ansWarning.Id}');" />
                                                        <br/><br/>
                                                        </apex:outputPanel> 
                                                            <apex:outputPanel style="display:block;" rendered="{!IF(AND(LEN(qWrap.ansWarning.SYSAttachmentId__c)>0,qWrap.ansWarning.SYSAttachmentId__c !=NULL ),'true','false')}">
                                                                <apex:outputPanel rendered="{!If(pageMode!='view',true,false)}">
                                                                    <apex:outputlink style="font-weight:bold" value="javascript:if (window.confirm('Are you sure?')) delAttachmentAF('{!qWrap.ansWarning.SYSAttachmentId__c}');"  disabled="{!IF((pagemode =='view'),true,false)}">Del
                                                                    </apex:outputlink>  
                                                                    <apex:outputText value=" | " style="white-space: pre" id="blankOutPutText8"/>
                                                                    
                                                                </apex:outputPanel>  
                                                            <apex:outputlink style="font-weight:bold" value="/servlet/servlet.FileDownload?file={!qWrap.ansWarning.SYSAttachmentId__c}" target="_blank">View {!mAttachment[qWrap.ansWarning.SYSAttachmentId__c].Name}
                                                            </apex:outputlink>
                                                            </apex:outputPanel>
                                                            <br/>
                                                            <apex:inputTextArea label="Description" value="{!qWrap.ansWarning.Detail__c}" styleclass="fileDescription"   style="width:{!(101 - qWrap.wrapperTreeLevel)}%; height:40px"  disabled="{!IF((pagemode =='view'),true,false)}"/>
                                                            
                                                        </apex:outputPanel>
                                                    </div>
                                                    
                                                    <apex:inputTextArea value="{!qWrap.ansWarning.Detail__c}" rendered="{!IF(qWrap.warningResponse!='File evidence to be attached',true,false)}"  disabled="{!IF(OR(qWrap.warningResponse=='Exception Raised',qWrap.warningResponse=='Exception Approved',Pagemode=='view'),true,false)}"   style="float: right; width: {!(92 - qWrap.wrapperTreeLevel)}%; height:40px" id="CommentsToEnter"/>
                                                    
                                                    <apex:inputTextArea value="{!qWrap.approvalcomments}" disabled="true"   style="float: right; width: {!(92 - qWrap.wrapperTreeLevel)}%; height:40px" rendered="{!IF(LEN(qWrap.approvalComments)>0,'true','false')}" id="CommentsGiven"/>
                                                </td>
                                                <td style="float:right;border-bottom:none;">
                                                    <apex:selectList id="chooseAnsWarning" style="color:{!IF((qWrap.warningResponse == 'Confirm Changes' || qWrap.warningResponse == 'N/A' ),'black','#77DD77')}" value="{!qWrap.warningResponse}" size="1"  disabled="{!IF(OR(qWrap.warningResponse=='Exception Raised',qWrap.warningResponse=='Exception Approved',Pagemode=='view'),true,false)}">
                                                        <apex:selectOptions value="{!qWrap.pickListValues}" id="responseAnsValues">
                                                            
                                                        </apex:selectOptions>
                                                        <apex:actionSupport event="onchange" action="{!onChangeOfAnswer}"  status="LoadingStatusSpinner" reRender="thePanel,scriptPanel" >
                                                        </apex:actionSupport>
                                                    </apex:selectList>
                                                </td>
                                            </tr>
                                        </apex:outputPanel>
                                    </td>
                                </tr>
                            </apex:repeat>
                            
                        </table>
                    </td>
                </tr>
                </apex:repeat> 
                
                <tr>
                    <td style="padding-bottom: 0px;padding-left: 0px;padding-top: 7px;padding-right: 0px;">
                        <table style="background-color: #1797C0;border-radius:7px">
                            <tr >
                                <td colspan="3" style="text-align:center">
                                    <apex:actionStatus id="mySaveStatus1">
                                        <apex:facet name="stop">
                                            <apex:commandButton value="{!$Label.IMH_OK}" action="{!confirmAction}" id="OkCommandButton" status="mySaveStatus1" disabled="false" 
                                                                oncomplete="if({!warningRaised}){alert('{!$Label.IMH_AlertExceptionRaised}');}redirectFunction();">
                                                <apex:param name="buttonCall" value="Save"/>
                                            </apex:commandButton>
                                        </apex:facet>
                                        <apex:facet name="start">
                                            <apex:commandButton action="{!confirmAction}" status="mySaveStatus1" value="Processing..." disabled="true" id="processingButton"/> 
                                        </apex:facet>
                                    </apex:actionStatus>
                                    <apex:outputText value="    " style="white-space: pre" id="blankOutPutText2"/>
                                    <apex:commandButton value="{!$Label.IMH_Cancel}" action="{!exitAction}" id="ExitCommandButton">
                                        <apex:param name="buttonCall" value="Exit"/>
                                    </apex:commandButton> 
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>  
              
        </apex:outputPanel>
        
    </apex:form> 
    <apex:outputPanel id="attachbuttonPanel" >
        <table class="tableA">
            <tr>
                <td>
                    <apex:form >
                        <apex:actionFunction action="{!delAttachment}" name="delAttachmentAF" reRender="scriptPanel,thePanel,listview" status="LoadingStatusSpinner">
                            <apex:param name="contIdParam" value=""/> 
                        </apex:actionFunction>
                        <apex:outputPanel id="listview">
                            <apex:pageBlock title="{!$Label.IMH_RelatedListAttachment}"  rendered="{!lattachment.size != 0}">
                                <apex:pageBlockTable value="{!lattachment}" var="attach">
                                    <apex:column headerValue="Action">  
                                        <apex:outputPanel rendered="{!If(pageMode!='view',true,false)}">
                                            <apex:outputlink style="font-weight:bold" value="javascript:if (window.confirm('Are you sure?')) delAttachmentAF('{!attach.Id}');"  disabled="{!IF((Pagemode =='view'),true,false)}">{!$Label.IMH_Attachment_Delete_Text}
                                            </apex:outputlink>  
                                            <apex:outputText value=" | " style="white-space: pre" id="blankOutPutText8"/>
                                        </apex:outputPanel>  
                                        <apex:outputlink style="font-weight:bold" value="/servlet/servlet.FileDownload?file={!attach.Id}" target="_blank">{!$Label.IMH_Attachment_View_Text}
                                        </apex:outputlink>
                                    </apex:column>
                                    <apex:column headerValue="Name" >
                                        <apex:outputLabel value="{!attach.Name}"/>
                                    </apex:column>
                                    <apex:column headerValue="Description" >
                                        <apex:outputLabel value="{!attach.Description}"/>
                                    </apex:column>
                                </apex:pageBlockTable>
                            </apex:pageBlock>
                        </apex:outputPanel>
                    </apex:form>
                </td>
            </tr>
         </table>  
    </apex:outputPanel> 
     <apex:actionStatus id="LoadingStatusSpinner">
         <apex:facet name="start">
              <div id="loadingDiv" class="loadingDiv" >
                   <span id="loadingHolder" class="loadingHolder">
                        <img class="loadingImage" title="{!$Label.IMH_SpinnerText}" alt="{!$Label.IMH_SpinnerText}" src="{!$Resource.IMH_LoadingSpinner}"/>
                        <span class="loadingDescription">{!$Label.IMH_SpinnerText}</span>
                   </span>
              </div>
         </apex:facet>
    </apex:actionStatus>
    <apex:includeScript value="{!$Resource.jQUERY_Latest}"/>
    <apex:includeScript value="{!URLFOR($Resource.TreeViewPlugin, '/TreeViewPlugin/js/jquery.treegrid.js')}"/>
    <apex:outputPanel id="scriptPanel">
        <script type="text/javascript">
        $(document).ready(function() {
            $('.tree').treegrid();
        });
        </script>  
        <script type="text/javascript">
        var __sfdcSessionId = '{!$Api.Session_ID}';
        </script>
        <script src="/soap/ajax/30.0/connection.js" type="text/javascript"></script>
        <script type="text/javascript">
        
        function uploadFile(styleClass){    
            var loadingSpinnerElement = document.getElementById('{!$Component.LoadingStatusSpinner}'+'.start');
            loadingSpinnerElement.style.display = 'block';
            var targetInputElement = document.getElementById(styleClass).getElementsByClassName("fileInput")[0];
            var targetHiddenElement = document.getElementById(styleClass).getElementsByClassName("inputHidden")[0]; 
            var targetDescription = document.getElementById(styleClass).getElementsByClassName("fileDescription")[0];
            
            var input = targetInputElement;
            var filesToUpload = input.files;
            
            if (typeof window.FileReader === 'undefined') {
                loadingSpinnerElement.style.display = 'None';
                alert('{!$Label.IMH_NoBrowser_Support}');
            }else{
                for(var i = 0, f; f = filesToUpload[i]; i++){
                if(f.size > 26214400){
                 alert('{!$Label.IMH_ATTACHMENT_LIMIT_EXCEED}');
                    loadingSpinnerElement.style.display = 'None';
                    break;
                }
                var reader = new FileReader();
                // Keep a reference to the File in the FileReader so it can be accessed in callbacks
                reader.file = f;

                reader.onload = function(e){
                    var att = new sforce.SObject("Attachment");
                    att.Name = this.file.name;
                    att.ContentType = this.file.type;
                    att.ParentId = '{!qWrapper.answerSetId}';
                    att.Description =targetDescription.value;
                    var binary = "";
                    var bytes = new Uint8Array(e.target.result);
                    var length = bytes.byteLength;
                        for (var i = 0; i < length; i++){
                            binary += String.fromCharCode(bytes[i]);
                        }
                        att.Body = (new sforce.Base64Binary(binary)).toString();
                        sforce.connection.create([att],{
                            onSuccess : function(result, source){
                                if (result[0].getBoolean("success")){
                                    targetHiddenElement.value = result[0].id;
                                    targetInputElement.disabled = 'true';
                                    loadingSpinnerElement.style.display = 'None';
                                    alert('{!$Label.IMH_Attachment_Success}');
                                    dummyRender();
                                    
                                }
                                else{
                                    loadingSpinnerElement.style.display = 'None';
                                    alert('{!$Label.IMH_Upload_NotSuccess}');
                                }
                            },
                            onFailure : function(error, source){
                                loadingSpinnerElement.style.display = 'None';
                                alert('{!$Label.IMH_Upload_NotSuccess}');
                            }
                        });
                };

                reader.readAsArrayBuffer(f);
            }
            }
            }
    </script>
    </apex:outputPanel>
    
</apex:page>